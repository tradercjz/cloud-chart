apiVersion: v1
kind: ServiceAccount
metadata:
  name: narwhal-sa
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: narwhal-admin-binding
subjects:
- kind: ServiceAccount
  name: narwhal-sa
  namespace: default
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: narwhal-backend
  namespace: default
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    # [修改 1] 匹配标签统一
    matchLabels:
      app: narwhal-backend
  template:
    metadata:
      labels:
        # [修改 2] Pod 的标签改为 narwhal-backend
        app: narwhal-backend
    spec:
      serviceAccountName: narwhal-sa
      # [确认] 必须注释掉 hostNetwork 以启用 K8s DNS
      # hostNetwork: true 

      dnsPolicy: ClusterFirst
      
      # 2. [新增] 强制指定 DNS 配置
      dnsConfig:
        nameservers:
          - 223.5.5.5        # 阿里云 DNS (国内推荐)
          - 114.114.114.114  # 114 DNS
          - 8.8.8.8          # Google DNS (备用)
        searches:
          - default.svc.cluster.local
          - svc.cluster.local
          - cluster.local
        options:
          - name: ndots
            value: "2" # 优化解析速度
      
      containers:
      - name: api
        image: narwhal-backend:v7
        imagePullPolicy: IfNotPresent
        # [确认] 容器监听 20003
        command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "20003", "--reload"]
        
        ports:
        - containerPort: 20003
        
        env:
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: DATABASE_URL
          value: "sqlite+aiosqlite:///./narwhal.db"
        
        volumeMounts:
        - name: source-code
          mountPath: /app
        - name: vector-store-dir
          mountPath: /mnt/ramdisk

      volumes:
      - name: source-code
        hostPath:
          path: /home/jzchen/Narwhal
          type: Directory
      - name: vector-store-dir
        hostPath:
          path: /mnt/ramdisk
          type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: narwhal-service
  namespace: default
spec:
  type: NodePort
  selector:
    # [修改 3] Service 选择器与 Deployment 标签一致
    app: narwhal-backend
  ports:
    - name: http
      port: 20003       # Service ClusterIP 的端口 (集群内部访问用)
      targetPort: 20003 # 必须等于容器 uvicorn 启动的端口
      nodePort: 30008   # 暴露给宿主机的端口 (OpenResty 访问用)